[gd_scene load_steps=3 format=2]

[sub_resource type="PhysicsMaterial" id=1]
friction = 0.0

[sub_resource type="GDScript" id=2]
script/source = "extends RigidBody2D

const bullet = preload(\"res://bullet.tscn\")

func _ready():
	set_physics_process(false)
	pass

func _integrate_forces(state):
	apply_impulse(Vector2(0,0), Vector2(2,0).rotated(rotation) )
	
	attack_enemy()

func _physics_process(delta):
	#get_node(\"../CanvasLayer/Label\").text = String(linear_velocity)
	pass

func attack_enemy():
	var target = find_target()
	if target == null:
		print(\"Error - missing target.\")
	else:
		face_target(target)

# Return target global coordinates
# Right, it is the closest target.
func find_target():
	var target = get_closest_enemy(global_position)
	get_node(\"../CanvasLayer/Label\").text = String(target.name)
	if target == null:
		return null
	else:
		return lead_target(target)

func lead_target(target):
	var vec = target.linear_velocity
	return target.global_position + (vec * (1.0/60.0))

# Adds angular velocity to face g_coords
func face_target(g_position):
	var att = angle_to_target(g_position)
	
	#if angle_to_target < deg2rad(2) and angle_to_target > deg2rad(-2):
	#	angular_velocity = 0
	if abs(att) >= deg2rad(0.5):
		#print(name,\": \",rad2deg(att), \" rot: \", rad2deg(rotation))
		if att >= 0:
			angular_velocity = 3
		else:
			angular_velocity = -3
	else:
		angular_velocity = 0
		fire()
	
func fire():
	var b = bullet.instance()
	b.global_position = get_node(\"Position2D\").global_position
	b.rotation = rotation
	get_parent().call_deferred(\"add_child\", b)
	b.apply_impulse(Vector2(0,0), Vector2(300,0).rotated(rotation) )

func angle_to_target(g_position):
	
	
	var g_rot = g_position.angle_to_point(position)
	var att
	#if g_rot >= 0:
	#	att = PI - g_rot
	#else:
	#	att = (-PI) - g_rot
	att = Vector2(1,0).rotated(rotation).angle_to(Vector2(1,0).rotated(g_rot))
	return att

# Accept global_position Vector2, Return closest enemy node or FALSE if no enemy group.
func get_closest_enemy(g_position):
	if !get_tree().has_group(\"enemies\"):
		return null
	
	var enemies = get_tree().get_nodes_in_group(\"enemies\")
	var current = enemies[0]
	if current.name == name:
		current = enemies[1]
	for x in enemies:
		if x.name != name:
			if x.global_position.distance_to(global_position) < current.global_position.distance_to(global_position):
				current = x
	#print(name, \": \", current.name)
	#label.name = current.name
	return current

func _unhandled_key_input(event):
	pass
"

[node name="RigidBody2D" type="RigidBody2D"]
collision_mask = 3
physics_material_override = SubResource( 1 )
linear_damp = 3.0
angular_damp = 0.0
script = SubResource( 2 )

[node name="Polygon2D" type="Polygon2D" parent="."]
rotation = 1.57057
polygon = PoolVector2Array( 0, -2, -1, 1, 1, 1 )

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="."]
visible = false
rotation = 1.57136
polygon = PoolVector2Array( 0, -2, -1, 1, 1, 1 )

[node name="Position2D" type="Position2D" parent="."]
position = Vector2( 3.5, 0 )
